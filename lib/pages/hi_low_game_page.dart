import 'dart:async';
import 'dart:math';
import 'package:flutter/material.dart' hide Card;
import '../models/card.dart' as poker;
import '../models/hand_rank.dart';
import '../models/low_hand_rank.dart';
import '../models/player.dart';
import '../models/score_system.dart';
import '../home_page.dart'; // AppLanguageÎ•º ÏÇ¨Ïö©ÌïòÍ∏∞ ÏúÑÌï¥ Ï∂îÍ∞Ä

class HiLowGamePage extends StatefulWidget {
  const HiLowGamePage({super.key});

  @override
  _HiLowGamePageState createState() => _HiLowGamePageState();
}

class ReplayRound {
  final List<List<String>> playerHands;
  final List<String> communityCards;
  final int? selectedHighWinnerIndex;
  final int? actualHighWinnerIndex;
  final List<int> selectedLowWinnerIndices;
  final List<int> actualLowWinnerIndices;
  final String winnerText;
  final int numberOfPlayers;
  final int roundScore;

  ReplayRound({
    required this.playerHands,
    required this.communityCards,
    required this.selectedHighWinnerIndex,
    required this.actualHighWinnerIndex,
    required this.selectedLowWinnerIndices,
    required this.actualLowWinnerIndices,
    required this.winnerText,
    required this.numberOfPlayers,
    required this.roundScore,
  });
}

class _HiLowGamePageState extends State<HiLowGamePage> {
  final List<String> deck = [
    'AS', '2S', '3S', '4S', '5S', '6S', '7S', '8S', '9S', '10S', 'JS', 'QS', 'KS',
    'AH', '2H', '3H', '4H', '5H', '6H', '7H', '8H', '9H', '10H', 'JH', 'QH', 'KH',
    'AD', '2D', '3D', '4D', '5D', '6D', '7D', '8D', '9D', '10D', 'JD', 'QD', 'KD',
    'AC', '2C', '3C', '4C', '5C', '6C', '7C', '8C', '9C', '10C', 'JC', 'QC', 'KC'
  ];

  List<Player> players = [];
  List<String> communityCards = [];
  bool isGameStarted = false;
  int remainingTime = 60;
  Timer? gameTimer;
  ScoreSystem scoreSystem = ScoreSystem();
  int? selectedHighWinnerIndex;
  int? actualHighWinnerIndex;
  List<int> selectedLowWinnerIndices = [];
  List<int> actualLowWinnerIndices = [];
  int currentScore = 0;
  String winnerText = '';
  int numberOfPlayers = 3;
  String highHandInfo = '';
  String lowHandInfo = '';
  bool isLowHand = false; // Î°úÏö∞ Ìï∏Îìú Ï°¥Ïû¨ Ïó¨Î∂Ä
  List<String> roundLogs = [];
  List<ReplayRound> replayRounds = [];
  ReplayRound? replayingRound;
  bool isSelectingHigh = true; // ÌòÑÏû¨ ÌïòÏù¥ Ìï∏Îìú ÏÑ†ÌÉù Ï§ëÏù∏ÏßÄ Î°úÏö∞ Ìï∏Îìú ÏÑ†ÌÉù Ï§ëÏù∏ÏßÄ Íµ¨Î∂Ñ
  bool isReviewMode = false; // Î¶¨Î∑∞ Î™®Îìú ÏÉÅÌÉú Î≥ÄÏàò Ï∂îÍ∞Ä
  int currentReviewIndex = 0; // ÌòÑÏû¨ Î¶¨Î∑∞ Ï§ëÏù∏ ÎùºÏö¥Îìú Ïù∏Îç±Ïä§

  // getText Ìï®ÏàòÎ•º Ï∂îÍ∞ÄÌïòÏó¨ AppLanguage ÌÅ¥ÎûòÏä§Î•º ÏÇ¨Ïö©
  String getText(String key) => AppLanguage.getText(key);

  @override
  void initState() {
    super.initState();
    initializePlayers();
  }

  @override
  void dispose() {
    gameTimer?.cancel();
    gameTimer = null;
    super.dispose();
  }

  void initializePlayers() {
    final random = Random();
    players = List.generate(
      6,
      (index) => Player(
        name: 'Player ${index + 1}',
        chips: (random.nextInt(4996) * 100) + 500,
        hand: [],
        position: Position.values[index % Position.values.length],
      ),
    );
  }

  void startNewGame() {
    setState(() {
      isGameStarted = true;
      remainingTime = 60;
      selectedHighWinnerIndex = null;
      selectedLowWinnerIndices = [];
      actualHighWinnerIndex = null;
      actualLowWinnerIndices = [];
      currentScore = 0;
      winnerText = '';
      highHandInfo = '';
      lowHandInfo = '';
      isSelectingHigh = true;

      final random = Random();
      deck.shuffle(random);

      communityCards = deck.sublist(0, 5);

      for (int i = 0; i < players.length; i++) {
        players[i].hand = deck.sublist(5 + i * 4, 5 + (i + 1) * 4);
      }

      gameTimer?.cancel();
      gameTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
        setState(() {
          if (remainingTime > 0) {
            remainingTime--;
          } else {
            timer.cancel();
            isGameStarted = false;
            if (currentScore > 0) {
              bool isNewHighScore = scoreSystem.addScore(numberOfPlayers, currentScore);
              if (isNewHighScore) {
                winnerText = '${getText("gameOver")}! ${getText("finalScore")}: $currentScore\nüéâ ${getText("congratulations")}! ${getText("newHighScore")}! üéâ';
              } else {
                winnerText = '${getText("gameOver")}! ${getText("finalScore")}: $currentScore\n(${getText("highScore")}: ${scoreSystem.getHighScore(numberOfPlayers)})';
              }
              
              // ÎßàÏßÄÎßâ ÎùºÏö¥Îìú Ï†ïÎ≥¥ ÌëúÏãú
              if (highHandInfo.isNotEmpty) {
                winnerText += '\n\nHi ${getText("winningHand")}: $highHandInfo';
              }
              if (lowHandInfo.isNotEmpty && isLowHand) {
                winnerText += '\nLow ${getText("winningHand")}: $lowHandInfo';
              }
            } else {
              winnerText = '${getText("gameOver")}! ${getText("finalScore")}: $currentScore';
            }
            // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
            gameTimer = null;
          }
        });
      });

      evaluateActualWinners();
    });
  }

  void dealNewRound() {
    setState(() {
      selectedHighWinnerIndex = null;
      selectedLowWinnerIndices = [];
      actualHighWinnerIndex = null;
      actualLowWinnerIndices = [];
      winnerText = '';
      isSelectingHigh = true;

      final random = Random();
      deck.shuffle(random);

      communityCards = deck.sublist(0, 5);

      for (int i = 0; i < numberOfPlayers; i++) {
        players[i].hand = deck.sublist(5 + i * 4, 5 + (i + 1) * 4);
      }

      evaluateActualWinners();
    });
  }

  void selectHighWinner(int index) {
    if (!isGameStarted || selectedHighWinnerIndex != null || !isSelectingHigh) return;

    setState(() {
      selectedHighWinnerIndex = index;
      scoreSystem.addAttempt(numberOfPlayers);

      if (selectedHighWinnerIndex == actualHighWinnerIndex) {
        // ÌïòÏù¥ Ìï∏Îìú Ï†ïÎãµ
        currentScore++;
        winnerText = '${getText("correctAnswer")}$currentScore\nHi ${getText("winningHand")}: $highHandInfo';
        
        // Low Ìï∏ÎìúÍ∞Ä ÏûàÏúºÎ©¥ Low Ìï∏Îìú ÏÑ†ÌÉù Îã®Í≥ÑÎ°ú ÎÑòÏñ¥Í∞ÄÍ∏∞
        if (isLowHand) {
          isSelectingHigh = false;
          winnerText += '\nÏù¥Ï†ú Low Ìï∏Îìú ÏäπÏûêÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
        } else {
          // Low Ìï∏Îìú ÏóÜÏùå Î©îÏãúÏßÄ Ï∂îÍ∞Ä
          winnerText += '\nÎ°úÏö∞ Ìï∏ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§';
          
          // Low Ìï∏Îìú ÏóÜÏúºÎ©¥ Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
          roundLogs.add('${getText("round")} ${roundLogs.length + 1}: High: Player ${index + 1} ${getText("selected")} ‚Üí ${getText("correct")}! (${getText("score")}: $currentScore)');
          replayRounds.add(ReplayRound(
            playerHands: players.take(numberOfPlayers).map((p) => List<String>.from(p.hand)).toList(),
            communityCards: List<String>.from(communityCards),
            selectedHighWinnerIndex: index,
            actualHighWinnerIndex: actualHighWinnerIndex,
            selectedLowWinnerIndices: [],
            actualLowWinnerIndices: [],
            winnerText: winnerText,
            numberOfPlayers: numberOfPlayers,
            roundScore: currentScore,
          ));
          Future.delayed(const Duration(seconds: 1), () {
            if (remainingTime > 0 && mounted) {
              dealNewRound();
            }
          });
        }
      } else {
        // ÌïòÏù¥ Ìï∏Îìú Ïò§Îãµ
        winnerText = '${getText("wrongAnswer")}${getText("correctAnswerIs")} Player ${actualHighWinnerIndex! + 1}.\nHi ${getText("winningHand")}: $highHandInfo';
        
        // Low Ìï∏ÎìúÍ∞Ä ÏûàÏúºÎ©¥ Low Ìï∏Îìú ÏÑ†ÌÉù Îã®Í≥ÑÎ°ú ÎÑòÏñ¥Í∞ÄÍ∏∞
        if (isLowHand) {
          isSelectingHigh = false;
          winnerText += '\nÏù¥Ï†ú Low Ìï∏Îìú ÏäπÏûêÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
          
        } else {
          // Low Ìï∏Îìú ÏóÜÏùå Î©îÏãúÏßÄ Ï∂îÍ∞Ä
          winnerText += '\nÎ°úÏö∞ Ìï∏ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§';
          
          // Low Ìï∏Îìú ÏóÜÏúºÎ©¥ Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
          roundLogs.add('${getText("round")} ${roundLogs.length + 1}: High: Player ${index + 1} ${getText("selected")} ‚Üí ${getText("wrong")}! (${getText("correct")}: Player ${actualHighWinnerIndex! + 1}, ${getText("score")}: $currentScore)');
          replayRounds.add(ReplayRound(
            playerHands: players.take(numberOfPlayers).map((p) => List<String>.from(p.hand)).toList(),
            communityCards: List<String>.from(communityCards),
            selectedHighWinnerIndex: index,
            actualHighWinnerIndex: actualHighWinnerIndex,
            selectedLowWinnerIndices: [],
            actualLowWinnerIndices: [],
            winnerText: winnerText,
            numberOfPlayers: numberOfPlayers,
            roundScore: currentScore,
          ));
          Future.delayed(const Duration(seconds: 1), () {
            if (remainingTime > 0 && mounted) {
              dealNewRound();
            }
          });
        }
      }
    });
  }

  void selectLowWinner(int index) {
    if (!isGameStarted || isSelectingHigh || !isLowHand) return;
    
    // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú ÌîåÎ†àÏù¥Ïñ¥Îäî ÏÑ†ÌÉù Ï∑®ÏÜå Í∞ÄÎä•ÌïòÍ≤å Ìï®
    if (selectedLowWinnerIndices.contains(index)) {
      setState(() {
        selectedLowWinnerIndices.remove(index);
      });
      return;
    }

    setState(() {
      selectedLowWinnerIndices.add(index);
      
      // ÏÑ†ÌÉùÌïú ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï†ïÎãµÏù∏ÏßÄ ÌôïÏù∏
      bool isCorrect = actualLowWinnerIndices.contains(index);
      
      // Î™®Îì† Ï†ïÎãµÏùÑ ÏÑ†ÌÉùÌñàÎäîÏßÄ ÌôïÏù∏
      bool allCorrectSelected = actualLowWinnerIndices.every((winnerIndex) => 
        selectedLowWinnerIndices.contains(winnerIndex));
      
      // Ïò§ÎãµÏùÑ ÏÑ†ÌÉùÌñàÎäîÏßÄ ÌôïÏù∏
      bool anyWrongSelected = selectedLowWinnerIndices.any((selectedIndex) => 
        !actualLowWinnerIndices.contains(selectedIndex));

      if (isCorrect && !anyWrongSelected) {
        // Ï†ïÎãµ ÏÑ†ÌÉù - ÏïÑÏßÅ Î™®Îì† ÏäπÏûêÎ•º ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏïòÏúºÎ©¥ Í≥ÑÏÜç ÏÑ†ÌÉù Í∞ÄÎä•
        if (allCorrectSelected) {
          // Î™®Îì† ÏäπÏûêÎ•º ÏÑ†ÌÉùÌñàÏúºÎ©¥ Ï†êÏàò Î∂ÄÏó¨ Î∞è Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
          currentScore++;
          winnerText = '${getText("correctAnswer")}$currentScore\nHi ${getText("winningHand")}: $highHandInfo\nLow ${getText("winningHand")}: $lowHandInfo';
          
          // ÎùºÏö¥Îìú Î°úÍ∑∏ Î∞è Î¶¨ÌîåÎ†àÏù¥ Ï†ïÎ≥¥ Ï†ÄÏû•
          String winnerListText = actualLowWinnerIndices.map((i) => 'Player ${i + 1}').join(', ');
          roundLogs.add('${getText("round")} ${roundLogs.length + 1}: High: Player ${selectedHighWinnerIndex! + 1}, '
              'Low: ${selectedLowWinnerIndices.map((i) => 'Player ${i + 1}').join('+')} ${getText("selected")} ‚Üí '
              '${getText("correct")}! (${getText("score")}: $currentScore)');
          
          replayRounds.add(ReplayRound(
            playerHands: players.take(numberOfPlayers).map((p) => List<String>.from(p.hand)).toList(),
            communityCards: List<String>.from(communityCards),
            selectedHighWinnerIndex: selectedHighWinnerIndex,
            actualHighWinnerIndex: actualHighWinnerIndex,
            selectedLowWinnerIndices: List<int>.from(selectedLowWinnerIndices),
            actualLowWinnerIndices: List<int>.from(actualLowWinnerIndices),
            winnerText: winnerText,
            numberOfPlayers: numberOfPlayers,
            roundScore: currentScore,
          ));
          
          // Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
          Future.delayed(const Duration(seconds: 1), () {
            if (remainingTime > 0 && mounted) {
              dealNewRound();
            }
          });
        } else {
          // ÏùºÎ∂Ä ÏäπÏûêÎßå ÏÑ†ÌÉùÌñàÏúºÎ©¥ Í≥ÑÏÜçÌï¥ÏÑú ÎÇòÎ®∏ÏßÄ ÏäπÏûêÎ•º Í≥†Î•¥ÎèÑÎ°ù Ìï®
          winnerText = 'Ï†ïÎãµ! Îã§Î•∏ ÏäπÏûêÎèÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.';
        }
      } else if (anyWrongSelected) {
        // Ïò§Îãµ ÏÑ†ÌÉù
        String correctWinners = actualLowWinnerIndices.map((i) => 'Player ${i + 1}').join(', ');
        winnerText = '${getText("wrongAnswer")}Low ${getText("correctAnswerIs")} $correctWinners\nHi ${getText("winningHand")}: $highHandInfo\nLow ${getText("winningHand")}: $lowHandInfo';
        
        roundLogs.add('${getText("round")} ${roundLogs.length + 1}: High: Player ${selectedHighWinnerIndex! + 1}, '
            'Low: ${selectedLowWinnerIndices.map((i) => 'Player ${i + 1}').join('+')} ${getText("selected")} ‚Üí '
            '${getText("wrong")}! (${getText("correct")}: $correctWinners, ${getText("score")}: $currentScore)');
        
        replayRounds.add(ReplayRound(
          playerHands: players.take(numberOfPlayers).map((p) => List<String>.from(p.hand)).toList(),
          communityCards: List<String>.from(communityCards),
          selectedHighWinnerIndex: selectedHighWinnerIndex,
          actualHighWinnerIndex: actualHighWinnerIndex,
          selectedLowWinnerIndices: List<int>.from(selectedLowWinnerIndices),
          actualLowWinnerIndices: List<int>.from(actualLowWinnerIndices),
          winnerText: winnerText,
          numberOfPlayers: numberOfPlayers,
          roundScore: currentScore,
        ));
        
        // Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
        Future.delayed(const Duration(seconds: 1), () {
          if (remainingTime > 0 && mounted) {
            dealNewRound();
          }
        });
      }
    });
  }

  void evaluateActualWinners() {
    // ÌïòÏù¥ Ìï∏Îìú Í≥ÑÏÇ∞
    evaluateHighHand();
    
    // Î°úÏö∞ Ìï∏Îìú Í≥ÑÏÇ∞
    evaluateLowHand();
  }
  
  void evaluateHighHand() {
    List<List<String>> playerHands = players.take(numberOfPlayers).map((p) => p.hand).toList();
    String bestHand = '';
    int highestRank = 0;
    int highestSecondaryRank = 0;
    actualHighWinnerIndex = -1;
    String winningHandDescription = '';
    String handTypeName = '';

    for (int i = 0; i < playerHands.length; i++) {
      var hands = generatePLOCombinations(playerHands[i], communityCards);
      String currentBestHand = '';
      int currentRank = 0;
      int currentSecondaryRank = 0;
      List<poker.Card> bestHandCards = [];
      String currentHandTypeName = '';

      for (var hand in hands) {
        var cards = hand.map((card) => poker.Card.fromString(card)).toList();
        var handRankObj = HandRank.evaluate(cards);

        if (handRankObj.value > currentRank ||
            (handRankObj.value == currentRank &&
                handRankObj.secondaryValue > currentSecondaryRank)) {
          currentRank = handRankObj.value;
          currentSecondaryRank = handRankObj.secondaryValue;
          currentBestHand = handRankObj.name;
          bestHandCards = cards;
          currentHandTypeName = handRankObj.name;
        }
      }

      if (currentRank > highestRank ||
          (currentRank == highestRank &&
              currentSecondaryRank > highestSecondaryRank)) {
        highestRank = currentRank;
        highestSecondaryRank = currentSecondaryRank;
        actualHighWinnerIndex = i;
        bestHand = currentBestHand;
        winningHandDescription = _getHandDescription(bestHandCards);
        handTypeName = currentHandTypeName;
      }
    }

    highHandInfo = '$handTypeName\n$winningHandDescription';
  }
  
  void evaluateLowHand() {
    List<List<String>> playerHands = players.take(numberOfPlayers).map((p) => p.hand).toList();
    List<LowHandRank?> playerLowRanks = List.filled(playerHands.length, null);
    actualLowWinnerIndices = [];
    isLowHand = false;
    
    // Í∞Å ÌîåÎ†àÏù¥Ïñ¥Ïùò ÏµúÍ≥† Î°úÏö∞ Ìï∏Îìú Ï∞æÍ∏∞
    for (int i = 0; i < playerHands.length; i++) {
      var hands = generatePLOCombinations(playerHands[i], communityCards);
      LowHandRank? bestLowHand;
      List<poker.Card>? bestLowHandCards;
      
      for (var hand in hands) {
        var cards = hand.map((card) => poker.Card.fromString(card)).toList();
        var lowHandRank = LowHandRank.evaluate(cards);
        
        // Îçî Ï¢ãÏùÄ Î°úÏö∞ Ìï∏ÎìúÏù∏ÏßÄ ÌôïÏù∏ (Î°úÏö∞Îäî Í∞íÏù¥ ÎÇÆÏùÑÏàòÎ°ù Ï¢ãÏùå)
        if (lowHandRank != null && (bestLowHand == null || 
            LowHandRank.compare(lowHandRank, bestLowHand) < 0)) {
          bestLowHand = lowHandRank;
          bestLowHandCards = cards;
        }
      }
      
      playerLowRanks[i] = bestLowHand;
      
      // Î°úÏö∞ Ìï∏ÎìúÍ∞Ä ÏûàÎäî ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏûàÏúºÎ©¥ isLowHandÎ•º trueÎ°ú ÏÑ§Ï†ï
      if (bestLowHand != null) {
        isLowHand = true;
      }
    }
    
    // ÎîîÎ≤ÑÍπÖ Ï∂úÎ†• - Í∞Å ÌîåÎ†àÏù¥Ïñ¥Ïùò Î°úÏö∞ Ìï∏Îìú Ï†ïÎ≥¥
    for (int i = 0; i < playerLowRanks.length; i++) {
      if (playerLowRanks[i] != null) {
        print('Player ${i+1} Î°úÏö∞ Ìï∏Îìú: ${playerLowRanks[i]!.name}, Í∞í: ${playerLowRanks[i]!.value}');
      }
    }
    
    // Î°úÏö∞ Ìï∏ÎìúÍ∞Ä ÏûàÏúºÎ©¥ ÏäπÏûê Í≤∞Ï†ï (ÎèôÏ†êÏûê Î™®Îëê ÏäπÏûêÎ°ú Ï∂îÍ∞Ä)
    if (isLowHand) {
      // ÏµúÍ≥†Ïùò Î°úÏö∞ Ìï∏Îìú Ï∞æÍ∏∞
      LowHandRank? bestLowHandRank;
      int bestPlayerIndex = -1;
      
      for (int i = 0; i < playerLowRanks.length; i++) {
        var lowRank = playerLowRanks[i];
        if (lowRank != null && (bestLowHandRank == null || 
            LowHandRank.compare(lowRank, bestLowHandRank) < 0)) {
          bestLowHandRank = lowRank;
          bestPlayerIndex = i;
        }
      }
      
      // ÏµúÍ≥† Î°úÏö∞ Ìï∏ÎìúÏôÄ ÎèôÏùºÌïú Îû≠ÌÅ¨Î•º Í∞ÄÏßÑ Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Î•º ÏäπÏûêÎ°ú ÏßÄÏ†ï
      if (bestLowHandRank != null) {
        for (int i = 0; i < playerLowRanks.length; i++) {
          var lowRank = playerLowRanks[i];
          if (lowRank != null && LowHandRank.compare(lowRank, bestLowHandRank) == 0) {
            actualLowWinnerIndices.add(i);
          }
        }
        
        // Î°úÏö∞ Ìï∏Îìú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        if (actualLowWinnerIndices.isNotEmpty) {
          // ÎÇ¥Î¶ºÏ∞®ÏàúÏúºÎ°ú Ï†ïÎ†¨Îêú Ïπ¥Îìú ÏàúÏÑúÎ°ú ÌëúÏãú (ÎÜíÏùÄ Ïπ¥ÎìúÎ∂ÄÌÑ∞)
          List<int> sortedRanks = List.from(bestLowHandRank.rankValues)..sort((a, b) => b.compareTo(a));
          String rankDisplay = sortedRanks.map((r) => r == 1 ? 'A' : r.toString()).join('-');
          lowHandInfo = '$rankDisplay';
          
          // Ïó¨Îü¨ ÏäπÏûêÍ∞Ä ÏûàÏúºÎ©¥ ÌîåÎ†àÏù¥Ïñ¥ Î≤àÌò∏ Ï∂îÍ∞Ä
          if (actualLowWinnerIndices.length > 1) {
            lowHandInfo += '\n(Ïä§ÌîåÎ¶ø: ${actualLowWinnerIndices.map((i) => 'Player ${i + 1}').join(', ')})';
          }
        }
      }
    } else {
      lowHandInfo = "Î°úÏö∞ Ìï∏Îìú ÏóÜÏùå";
    }
  }

  // PLO Ï°∞Ìï© ÏÉùÏÑ± (2Ïû•Ïùò Ìï∏Îìú Ïπ¥Îìú + 3Ïû•Ïùò Ïª§ÎÆ§ÎãàÌã∞ Ïπ¥Îìú)
  List<List<String>> generatePLOCombinations(List<String> hand, List<String> community) {
    List<List<String>> result = [];
    
    // Ìï∏ÎìúÏóêÏÑú 2Ïû• ÏÑ†ÌÉùÌïòÎäî Î™®Îì† Ï°∞Ìï©
    for (int i = 0; i < hand.length; i++) {
      for (int j = i + 1; j < hand.length; j++) {
        // Ïª§ÎÆ§ÎãàÌã∞ÏóêÏÑú 3Ïû• ÏÑ†ÌÉùÌïòÎäî Î™®Îì† Ï°∞Ìï©
        for (int k = 0; k < community.length; k++) {
          for (int l = k + 1; l < community.length; l++) {
            for (int m = l + 1; m < community.length; m++) {
              result.add([hand[i], hand[j], community[k], community[l], community[m]]);
            }
          }
        }
      }
    }
    
    return result;
  }

  String _getHandDescription(List<poker.Card> cards) {
    cards.sort((a, b) => b.rank.index.compareTo(a.rank.index));
    List<String> cardStrs = cards.map((card) {
      String rankStr = _getRankString(card.rank);
      String suitStr = _getSuitString(card.suit);
      return '$rankStr$suitStr';
    }).toList();
    return cardStrs.join(' ');
  }

  String _getRankString(poker.Rank rank) {
    switch (rank) {
      case poker.Rank.ace:
        return 'A';
      case poker.Rank.king:
        return 'K';
      case poker.Rank.queen:
        return 'Q';
      case poker.Rank.jack:
        return 'J';
      case poker.Rank.ten:
        return '10';
      default:
        return (rank.index + 2).toString();
    }
  }

  String _getSuitString(poker.Suit suit) {
    switch (suit) {
      case poker.Suit.spades:
        return '‚ô†';
      case poker.Suit.hearts:
        return '‚ô•';
      case poker.Suit.diamonds:
        return '‚ô¶';
      case poker.Suit.clubs:
        return '‚ô£';
      default:
        return '';
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Hi/Low Î≥¥ÎìúÎ¶¨Îî©', style: TextStyle(color: Colors.white)),
        backgroundColor: Color(0xFF1B5E20),
        elevation: 0,
        leading: IconButton(
          icon: Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () {
            // Í≤åÏûÑ ÏßÑÌñâ Ï§ëÏù¥Î©¥ Í≤åÏûÑÏùÑ Ï§ëÎã®ÌïòÍ≥† ÏãúÏûë ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            if (isGameStarted) {
              setState(() {
                isGameStarted = false;
                gameTimer?.cancel();
                gameTimer = null;
              });
            } else if (isReviewMode) {
              // Î¶¨Î∑∞ Î™®ÎìúÎùºÎ©¥ Î¶¨Î∑∞ Î™®Îìú Ï¢ÖÎ£å
              endReviewMode();
            } else {
              // Í∑∏ Ïô∏ÏóêÎäî Ïù¥Ï†Ñ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
              Navigator.of(context).pop();
            }
          },
        ),
        actions: [
          // Î¶¨Î∑∞ Î≤ÑÌäº Ï∂îÍ∞Ä - Í≤åÏûÑ Ï¢ÖÎ£å ÌõÑÎÇò ÎùºÏö¥ÎìúÍ∞Ä ÏûàÏùÑ Îïå ÌëúÏãú
          if (!isReviewMode && replayRounds.isNotEmpty)
            Padding(
              padding: const EdgeInsets.only(right: 12.0),
              child: ElevatedButton.icon(
                onPressed: startReviewMode,
                icon: Icon(Icons.history, color: Colors.white),
                label: Text(
                  getText('review'),
                  style: TextStyle(color: Colors.white),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.amber,
                  foregroundColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(20),
                  ),
                ),
              ),
            ),
        ],
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Color(0xFF1B5E20),
              Color(0xFF2E7D32),
              Color(0xFF4CAF50),
            ],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // ÏÉÅÎã® Ï†êÏàò Î∞è ÌÉÄÏù¥Î®∏ ÌëúÏãú - Î¶¨Î∑∞ Î™®ÎìúÏùº ÎïåÎäî Ï†úÍ±∞ (Î¶¨Î∑∞ UIÏóê ÌÜµÌï©Îê®)
              if (!isReviewMode)
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        '${getText("score")}: $currentScore',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      if (isGameStarted)
                        Text(
                          '${getText("remainingTime")}: $remainingTime ${getText("seconds")}',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                    ],
                  ),
                ),
              
              // Í≤åÏûÑ ÏòÅÏó≠
              Expanded(
                child: isReviewMode
                    ? _buildReviewMode()
                    : !isGameStarted
                        ? _buildStartScreen()
                        : _buildGamePlayArea(),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildStartScreen() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(
            'Hi/Low Î≥¥ÎìúÎ¶¨Îî© Í≤åÏûÑ',
            style: TextStyle(
              color: Colors.white,
              fontSize: 24,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 20),
          
          // ÌîåÎ†àÏù¥Ïñ¥ Ïàò ÏÑ†ÌÉù
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 32.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  getText('playerCount'),
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 8),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  children: [3, 4, 5, 6].map((count) {
                    return GestureDetector(
                      onTap: () {
                        setState(() {
                          numberOfPlayers = count;
                        });
                      },
                      child: Container(
                        padding: EdgeInsets.symmetric(vertical: 10, horizontal: 20),
                        decoration: BoxDecoration(
                          color: numberOfPlayers == count
                              ? Colors.amber
                              : Colors.white.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(10),
                        ),
                        child: Text(
                          count.toString(),
                          style: TextStyle(
                            color: numberOfPlayers == count ? Colors.black : Colors.white,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    );
                  }).toList(),
                ),
              ],
            ),
          ),
          
          SizedBox(height: 40),
          
          // Í≤åÏûÑ ÏãúÏûë Î≤ÑÌäº
          ElevatedButton(
            onPressed: startNewGame,
            style: ElevatedButton.styleFrom(
              padding: EdgeInsets.symmetric(horizontal: 40, vertical: 12),
              backgroundColor: Colors.white,
              foregroundColor: Color(0xFF1B5E20),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(30),
              ),
            ),
            child: Text(
              getText('startGame'),
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          
          SizedBox(height: 20),
          
          // ÏµúÍ≥† Ï†êÏàò ÌëúÏãú
          Text(
            '${getText("highScore")}: ${scoreSystem.getHighScore(numberOfPlayers)}',
            style: TextStyle(
              color: Colors.white,
              fontSize: 16,
            ),
          ),
          
          // Ïù¥Ï†Ñ Í≤åÏûÑÏùò ÎùºÏö¥Îìú Î°úÍ∑∏Í∞Ä ÏûàÏúºÎ©¥ Î¶¨Î∑∞ Î≤ÑÌäº ÌëúÏãú
          if (replayRounds.isNotEmpty)
            Padding(
              padding: const EdgeInsets.only(top: 20.0),
              child: ElevatedButton.icon(
                onPressed: startReviewMode,
                icon: Icon(Icons.history),
                label: Text(getText('review')),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.amber,
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(20),
                  ),
                ),
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildGamePlayArea() {
    return Column(
      children: [
        // Ïª§ÎÆ§ÎãàÌã∞ Ïπ¥Îìú ÏòÅÏó≠
        Padding(
          padding: const EdgeInsets.all(8.0),
          child: Column(
            children: [
              Text(
                getText('communityCards'),
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: 8),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: communityCards
                    .map((card) => _buildCard(card, margin: 4))
                    .toList(),
              ),
            ],
          ),
        ),
        
        // ÌòÑÏû¨ ÏÑ†ÌÉù Î™®Îìú ÌëúÏãú
        if (isGameStarted && selectedHighWinnerIndex == null && selectedLowWinnerIndices.isEmpty)
          Container(
            margin: EdgeInsets.symmetric(vertical: 8),
            padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            decoration: BoxDecoration(
              color: isSelectingHigh ? Colors.amber.withOpacity(0.7) : Colors.green.withOpacity(0.7),
              borderRadius: BorderRadius.circular(20),
            ),
            child: Text(
              isSelectingHigh ? "High Ìï∏Îìú ÏäπÏûê ÏÑ†ÌÉù" : "Low Ìï∏Îìú ÏäπÏûê ÏÑ†ÌÉù",
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 16,
              ),
            ),
          ),
        
        // ÏÑ†ÌÉù Ïù∏Ïä§Ìä∏Îü≠ÏÖò ÌëúÏãú (Î°úÏö∞ Ìï∏ÎìúÏóê Ïó¨Îü¨ ÏäπÏûêÍ∞Ä ÏûàÏùÑ Í≤ΩÏö∞)
        if (isGameStarted && !isSelectingHigh && actualLowWinnerIndices.length > 1 && 
            selectedLowWinnerIndices.isNotEmpty && selectedLowWinnerIndices.length < actualLowWinnerIndices.length)
          Container(
            margin: EdgeInsets.symmetric(vertical: 4),
            padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            decoration: BoxDecoration(
              color: Colors.blue.withOpacity(0.7),
              borderRadius: BorderRadius.circular(20),
            ),
            child: Text(
              "Ïó¨Îü¨ ÏäπÏûêÍ∞Ä ÏûàÏäµÎãàÎã§. Î™®Îì† ÏäπÏûêÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.",
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 14,
              ),
            ),
          ),
        
        // Í≤∞Í≥º Î©îÏãúÏßÄ ÏòÅÏó≠
        if (winnerText.isNotEmpty)
          Container(
            margin: EdgeInsets.symmetric(vertical: 8, horizontal: 16),
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.white.withOpacity(0.15),
              borderRadius: BorderRadius.circular(10),
              border: Border.all(
                color: Colors.white.withOpacity(0.2),
                width: 1,
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 3,
                  offset: Offset(0, 2),
                ),
              ],
            ),
            child: Text(
              winnerText,
              style: TextStyle(
                color: Colors.white,
                fontSize: 16,
                fontWeight: FontWeight.bold,
                height: 1.3,
              ),
              textAlign: TextAlign.center,
            ),
          ),
        
        // ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú ÏòÅÏó≠
        Expanded(
          child: GridView.builder(
            padding: EdgeInsets.all(8),
            gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: 2,
              childAspectRatio: 1.5,
              crossAxisSpacing: 8,
              mainAxisSpacing: 8,
            ),
            itemCount: numberOfPlayers,
            itemBuilder: (context, index) {
              bool isHighSelected = selectedHighWinnerIndex == index;
              bool isLowSelected = selectedLowWinnerIndices.contains(index);
              bool isHighCorrect = actualHighWinnerIndex == index && selectedHighWinnerIndex != null;
              
              Color borderColor = Colors.transparent;
              if (isHighSelected && isSelectingHigh) {
                borderColor = Colors.amber;
              } else if (isLowSelected && !isSelectingHigh) {
                borderColor = Colors.green;
              } else if (isHighCorrect && isSelectingHigh) {
                borderColor = Colors.blue;
              }
              
              return GestureDetector(
                onTap: () {
                  if (isSelectingHigh) {
                    selectHighWinner(index);
                  } else {
                    selectLowWinner(index);
                  }
                },
                child: Stack(
                  children: [
                    Container(
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.1),
                        borderRadius: BorderRadius.circular(10),
                        border: Border.all(
                          color: borderColor,
                          width: borderColor != Colors.transparent ? 3 : 0,
                        ),
                      ),
                      padding: EdgeInsets.all(8),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.center,
                        children: [
                          Text(
                            'Player ${index + 1}',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                            ),
                          ),
                          SizedBox(height: 8),
                          Wrap(
                            alignment: WrapAlignment.center,
                            spacing: 4,
                            runSpacing: 4,
                            children: players[index]
                                .hand
                                .map((card) => _buildCard(card, size: 36))
                                .toList(),
                          ),
                        ],
                      ),
                    ),
                    
                    // High Ìï∏Îìú ÏäπÏûê ÌëúÏãú (ÏÑ†ÌÉù ÌõÑÏóêÎßå)
                    if (isHighCorrect && selectedHighWinnerIndex != null)
                      Positioned(
                        top: 5,
                        right: 5,
                        child: Container(
                          padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: Colors.blue,
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Text(
                            'High',
                            style: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 12,
                            ),
                          ),
                        ),
                      ),
                    
                    // Low Ìï∏Îìú ÏÑ†ÌÉù ÌëúÏãú (Ïó¨Îü¨ Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•Ìïú Í≤ΩÏö∞)
                    if (!isSelectingHigh && isLowSelected)
                      Positioned(
                        bottom: 5,
                        right: 5,
                        child: Container(
                          padding: EdgeInsets.all(4),
                          decoration: BoxDecoration(
                            color: Colors.green,
                            shape: BoxShape.circle,
                          ),
                          child: Icon(
                            Icons.check,
                            color: Colors.white,
                            size: 16,
                          ),
                        ),
                      ),
                  ],
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildCard(String card, {double size = 50, double margin = 0}) {
    String suit = card.substring(card.length - 1);
    String rank = card.substring(0, card.length - 1);
    
    Color suitColor;
    String suitSymbol;
    
    switch (suit) {
      case 'S':
        suitColor = Colors.black;
        suitSymbol = '‚ô†';
        break;
      case 'H':
        suitColor = Colors.red;
        suitSymbol = '‚ô•';
        break;
      case 'D':
        suitColor = Colors.red;
        suitSymbol = '‚ô¶';
        break;
      case 'C':
        suitColor = Colors.black;
        suitSymbol = '‚ô£';
        break;
      default:
        suitColor = Colors.black;
        suitSymbol = '';
    }
    
    return Container(
      width: size,
      height: size * 1.4,
      margin: EdgeInsets.all(margin),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(size * 0.1),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.2),
            blurRadius: 3,
            offset: Offset(1, 1),
          ),
        ],
      ),
      child: Stack(
        children: [
          Positioned(
            top: 2,
            left: 4,
            child: Text(
              rank,
              style: TextStyle(
                color: suitColor,
                fontSize: size * 0.3,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          Center(
            child: Text(
              suitSymbol,
              style: TextStyle(
                color: suitColor,
                fontSize: size * 0.5,
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Î¶¨Î∑∞ Î™®Îìú ÏãúÏûë Ìï®Ïàò Ï∂îÍ∞Ä
  void startReviewMode() {
    if (replayRounds.isEmpty) return;
    
    setState(() {
      isReviewMode = true;
      currentReviewIndex = replayRounds.length - 1; // ÎßàÏßÄÎßâ ÎùºÏö¥ÎìúÎ∂ÄÌÑ∞ ÏãúÏûë
      showReplayRound(currentReviewIndex);
    });
  }
  
  // Î¶¨Î∑∞ Î™®Îìú Ï¢ÖÎ£å Ìï®Ïàò Ï∂îÍ∞Ä
  void endReviewMode() {
    setState(() {
      isReviewMode = false;
      replayingRound = null;
    });
  }
  
  // ÌäπÏ†ï ÎùºÏö¥Îìú Î¶¨ÌîåÎ†àÏù¥ ÌëúÏãú
  void showReplayRound(int index) {
    if (index < 0 || index >= replayRounds.length) return;
    
    setState(() {
      replayingRound = replayRounds[index];
      winnerText = replayingRound!.winnerText;
    });
  }
  
  // Îã§Ïùå Î¶¨Î∑∞ ÎùºÏö¥ÎìúÎ°ú Ïù¥Îèô
  void nextReviewRound() {
    if (currentReviewIndex < replayRounds.length - 1) {
      setState(() {
        currentReviewIndex++;
        showReplayRound(currentReviewIndex);
      });
    }
  }
  
  // Ïù¥Ï†Ñ Î¶¨Î∑∞ ÎùºÏö¥ÎìúÎ°ú Ïù¥Îèô
  void previousReviewRound() {
    if (currentReviewIndex > 0) {
      setState(() {
        currentReviewIndex--;
        showReplayRound(currentReviewIndex);
      });
    }
  }

  // Î¶¨Î∑∞ Î™®Îìú UIÏóêÏÑú Ïó¨Îü¨ Low Ìï∏Îìú ÏäπÏûê ÌëúÏãú Î°úÏßÅ ÏàòÏ†ï
  Widget _buildReviewMode() {
    if (replayingRound == null) return Container();
    
    return Column(
      children: [
        // Î¶¨Î∑∞ Ï†ïÎ≥¥ÏôÄ ÎùºÏö¥Îìú ÌÉêÏÉâ Î≤ÑÌäºÏùÑ ÌïòÎÇòÏùò ÌñâÏúºÎ°ú ÌÜµÌï©
        Padding(
          padding: const EdgeInsets.symmetric(vertical: 4.0, horizontal: 8.0),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // Î¶¨Î∑∞ Ï†ïÎ≥¥
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 12.0, vertical: 4.0),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.15),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Text(
                  '${getText("review")}: ${currentReviewIndex + 1}/${replayRounds.length}',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
              
              SizedBox(width: 12),
              
              // ÎùºÏö¥Îìú ÌÉêÏÉâ Ïª®Ìä∏Î°§
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8.0, vertical: 4.0),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.15),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    IconButton(
                      icon: Icon(Icons.arrow_back_ios, color: Colors.white),
                      onPressed: currentReviewIndex > 0 ? previousReviewRound : null,
                      iconSize: 16,
                      padding: EdgeInsets.zero,
                      constraints: BoxConstraints(minWidth: 24, minHeight: 24),
                    ),
                    Text(
                      '${getText("round")} ${currentReviewIndex + 1}',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    IconButton(
                      icon: Icon(Icons.arrow_forward_ios, color: Colors.white),
                      onPressed: currentReviewIndex < replayRounds.length - 1 ? nextReviewRound : null,
                      iconSize: 16,
                      padding: EdgeInsets.zero,
                      constraints: BoxConstraints(minWidth: 24, minHeight: 24),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
        
        // Ïª§ÎÆ§ÎãàÌã∞ Ïπ¥Îìú ÏòÅÏó≠
        Padding(
          padding: const EdgeInsets.all(4.0),
          child: Column(
            children: [
              Container(
                padding: EdgeInsets.symmetric(horizontal: 12, vertical: 4),
                decoration: BoxDecoration(
                  color: Colors.amber.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Text(
                  getText('communityCards'),
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
              SizedBox(height: 4),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: replayingRound!.communityCards
                    .map((card) => _buildCard(card, margin: 2))
                    .toList(),
              ),
            ],
          ),
        ),
        
        // Í≤∞Í≥º Î©îÏãúÏßÄ ÏòÅÏó≠
        if (replayingRound!.winnerText.isNotEmpty)
          Container(
            margin: EdgeInsets.symmetric(vertical: 4, horizontal: 16),
            padding: EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: Colors.white.withOpacity(0.2),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.white.withOpacity(0.3), width: 1),
            ),
            child: Text(
              replayingRound!.winnerText,
              style: TextStyle(
                color: Colors.white,
                fontSize: 14,
                fontWeight: FontWeight.bold,
                height: 1.2,
              ),
              textAlign: TextAlign.center,
            ),
          ),
        
        // ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú ÏòÅÏó≠
        Expanded(
          child: GridView.builder(
            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: 2,
              childAspectRatio: 1.4,
              crossAxisSpacing: 8,
              mainAxisSpacing: 8,
            ),
            itemCount: replayingRound!.numberOfPlayers,
            itemBuilder: (context, index) {
              bool isHighSelected = replayingRound!.selectedHighWinnerIndex == index;
              bool isLowSelected = replayingRound!.selectedLowWinnerIndices.contains(index);
              bool isHighCorrect = replayingRound!.actualHighWinnerIndex == index;
              bool isLowCorrect = replayingRound!.actualLowWinnerIndices.contains(index);
              
              // High Ìï∏Îìú ÏÑ†ÌÉù ÏÉÅÌÉú
              String highStatus = '';
              Color highStatusColor = Colors.transparent;
              IconData? highIcon;
              
              if (isHighSelected) {
                if (isHighCorrect) {
                  highStatus = 'High: Ï†ïÎãµ';
                  highStatusColor = Colors.green.shade300;
                  highIcon = Icons.check_circle;
                } else {
                  highStatus = 'High: Ïò§Îãµ';
                  highStatusColor = Colors.red.shade300;
                  highIcon = Icons.cancel;
                }
              } else if (isHighCorrect) {
                highStatus = 'High: Ï†ïÎãµ';
                highStatusColor = Colors.blue.shade300;
                highIcon = Icons.check_circle_outline;
              }
              
              // Low Ìï∏Îìú ÏÑ†ÌÉù ÏÉÅÌÉú
              String lowStatus = '';
              Color lowStatusColor = Colors.transparent;
              IconData? lowIcon;
              
              if (isLowSelected) {
                if (isLowCorrect) {
                  lowStatus = 'Low: Ï†ïÎãµ';
                  lowStatusColor = Colors.green.shade300;
                  lowIcon = Icons.check_circle;
                } else {
                  lowStatus = 'Low: Ïò§Îãµ';
                  lowStatusColor = Colors.red.shade300;
                  lowIcon = Icons.cancel;
                }
              } else if (isLowCorrect) {
                // ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùÄ Ï†ïÎãµ ÌîåÎ†àÏù¥Ïñ¥ (Îã§Î•∏ Ï†ïÎãµ ÌîåÎ†àÏù¥Ïñ¥Î•º ÏÑ†ÌÉùÌïú Í≤ΩÏö∞)
                if (replayingRound!.selectedLowWinnerIndices.isNotEmpty && 
                    replayingRound!.actualLowWinnerIndices.any((i) => 
                        replayingRound!.selectedLowWinnerIndices.contains(i))) {
                  lowStatus = 'Low: ÎØ∏ÏÑ†ÌÉù Ï†ïÎãµ';
                  lowStatusColor = Colors.blue.shade300;
                  lowIcon = Icons.check_circle_outline;
                } else {
                  lowStatus = 'Low: Ï†ïÎãµ';
                  lowStatusColor = Colors.teal.shade300;
                  lowIcon = Icons.check_circle_outline;
                }
              }
              
              // ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú Ïª®ÌÖåÏù¥ÎÑà ÏÉâÏÉÅ Í≤∞Ï†ï
              Color containerColor = Colors.white.withOpacity(0.15);
              if (isHighCorrect || isLowCorrect) {
                containerColor = Colors.white.withOpacity(0.25);
              }
              
              // Ïó¨Îü¨ Low Ìï∏Îìú ÏäπÏûêÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ ÌëúÏãú
              String multiWinnerLabel = '';
              if (isLowCorrect && replayingRound!.actualLowWinnerIndices.length > 1) {
                multiWinnerLabel = 'Low Ïä§ÌîåÎ¶ø';
              }
              
              return Container(
                decoration: BoxDecoration(
                  color: containerColor,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.1),
                      blurRadius: 5,
                      offset: Offset(0, 2),
                    ),
                  ],
                  border: Border.all(
                    color: (isHighCorrect || isLowCorrect) ? 
                           Colors.amber.withOpacity(0.5) : 
                           Colors.transparent,
                    width: 2,
                  ),
                ),
                padding: EdgeInsets.all(8),
                child: Column(
                  children: [
                    Text(
                      'Player ${index + 1}',
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                      ),
                    ),
                    SizedBox(height: 8),
                    Wrap(
                      alignment: WrapAlignment.center,
                      spacing: 4,
                      runSpacing: 4,
                      children: replayingRound!.playerHands[index]
                          .map((card) => _buildCard(card, size: 36))
                          .toList(),
                    ),
                    Spacer(),
                    
                    // Ïó¨Îü¨ Î°úÏö∞ Ìï∏Îìú ÏäπÏûê ÌëúÏãú
                    if (multiWinnerLabel.isNotEmpty)
                      Container(
                        margin: EdgeInsets.only(bottom: 4),
                        padding: EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                        decoration: BoxDecoration(
                          color: Colors.purple.shade300,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Text(
                          multiWinnerLabel,
                          style: TextStyle(
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                            fontSize: 10,
                          ),
                        ),
                      ),
                    
                    // High Î∞è Low ÏÉÅÌÉú ÌëúÏãú
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        // High Ìï∏Îìú Ï†ïÎãµ/Ïò§Îãµ ÌëúÏãú
                        if (highStatus.isNotEmpty)
                          Container(
                            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                            decoration: BoxDecoration(
                              color: highStatusColor,
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                if (highIcon != null)
                                  Icon(highIcon, color: Colors.white, size: 14),
                                SizedBox(width: 4),
                                Text(
                                  highStatus,
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontWeight: FontWeight.bold,
                                    fontSize: 12,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        
                        // Low Ìï∏Îìú Ï†ïÎãµ/Ïò§Îãµ ÌëúÏãú
                        if (lowStatus.isNotEmpty)
                          Container(
                            margin: EdgeInsets.only(left: highStatus.isNotEmpty ? 4 : 0),
                            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                            decoration: BoxDecoration(
                              color: lowStatusColor,
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                if (lowIcon != null)
                                  Icon(lowIcon, color: Colors.white, size: 14),
                                SizedBox(width: 4),
                                Text(
                                  lowStatus,
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontWeight: FontWeight.bold,
                                    fontSize: 12,
                                  ),
                                ),
                              ],
                            ),
                          ),
                      ],
                    ),
                  ],
                ),
              );
            },
          ),
        ),
        
        // Î¶¨Î∑∞ Ï¢ÖÎ£å Î≤ÑÌäº - ÌïòÎã® Ïó¨Î∞± ÏµúÏÜåÌôî
        Padding(
          padding: const EdgeInsets.only(bottom: 8.0),
          child: ElevatedButton.icon(
            onPressed: endReviewMode,
            icon: Icon(Icons.arrow_back, size: 16),
            label: Text(getText('endReplay')),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.white,
              foregroundColor: Color(0xFF1B5E20),
              padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(20),
              ),
              minimumSize: Size(120, 36),
              elevation: 2,
            ),
          ),
        ),
      ],
    );
  }
} 